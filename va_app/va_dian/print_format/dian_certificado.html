{% set tercero = frappe.get_doc("DIAN tercero", doc.dian_tercero) %}

<style>
  body {
    font-family: Arial, sans-serif;
    font-size: 11px;
  }
  .header {
    text-align: center;
    margin-bottom: 20px;
  }
  .section {
    margin-top: 15px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
  }
  th, td {
    border: 1px solid #000;
    padding: 5px;
    text-align: right;
  }
  th {
    background-color: #f0f0f0;
  }
  .left {
    text-align: left;
  }
</style>

<div class="header">
  <h3>
    CERTIFICADO DE
    {% if doc.certificate_type == "RET_FUENTE" %}
      RETENCIÓN EN LA FUENTE
    {% elif doc.certificate_type == "RET_IVA" %}
      RETENCIÓN DE IVA
    {% elif doc.certificate_type == "RET_ICA" %}
      RETENCIÓN DE INDUSTRIA Y COMERCIO
    {% endif %}
  </h3>
  <p>
    Año gravable {{ doc.year }}
  </p>
</div>

<div class="section">
  <strong>Agente Retenedor:</strong><br>
  {{ doc.company }}<br>
</div>

<div class="section">
  <strong>Tercero:</strong><br>
  {{ tercero.nombre_completo }}<br>
  NIT {{ tercero.nit }}{% if tercero.dv %}-{{ tercero.dv }}{% endif %}<br>
  {{ tercero.direccion or "" }}
</div>

{% if doc.municipio %}
<div class="section">
  <strong>Municipio:</strong> {{ doc.municipio }}
</div>
{% endif %}

<div class="section">
  <table>
    <thead>
      <tr>
        <th class="left">Cuenta Base</th>
        <th class="left">Cuenta Retención</th>
        <th>Base</th>
        <th>Valor Retenido</th>
      </tr>
    </thead>
    <tbody>
      {% for row in doc.details %}
      <tr>
        <td class="left">{{ row.base_account }}</td>
        <td class="left">{{ row.retention_account }}</td>
        <td>{{ frappe.format(row.base_amount, {"fieldtype": "Currency"}) }}</td>
        <td>{{ frappe.format(row.retained_amount, {"fieldtype": "Currency"}) }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="2" class="left">TOTALES</th>
        <th>{{ frappe.format(doc.total_base, {"fieldtype": "Currency"}) }}</th>
        <th>{{ frappe.format(doc.total_retained, {"fieldtype": "Currency"}) }}</th>
      </tr>
    </tfoot>
  </table>
</div>

{% set legends = [] %}
{% for row in doc.details %}
  {% set cfg = frappe.get_doc("DIAN_CertificadoConfig", row.config_reference) %}
  {% if cfg.print_legend and cfg.print_legend not in legends %}
    {% set _ = legends.append(cfg.print_legend) %}
  {% endif %}
{% endfor %}

{% if legends %}
<div class="section">
  <strong>Observaciones legales:</strong>
  <ul>
    {% for l in legends %}
      <li>{{ l }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div class="section">
  Certificado expedido el {{ frappe.utils.formatdate(doc.creation) }}.
</div>
